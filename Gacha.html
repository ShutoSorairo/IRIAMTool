<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¬ãƒãƒ£è¨­å®š</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š (AllGift.cssãƒ™ãƒ¼ã‚¹) */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #e0f7fa 0%, #fce4ec 100%);
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }

        /* ãƒœã‚¿ãƒ³ç³» */
        .btn-blue { background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 10px 18px; cursor: pointer; transition: background 0.2s; }
        .btn-blue:hover { background: #1565c0; }
        .btn-red { background: #d32f2f; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; cursor: pointer; }
        .btn-red:hover { background: #b71c1c; }
        .btn-green { background: #2e7d32; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; font-size: 0.9em; cursor: pointer; }
        
        .home-btn { position: absolute; top: 20px; left: 20px; background: #1976d2; color: #fff; border: none; border-radius: 4px; padding: 10px 30px; text-decoration: none; z-index: 100; }
        .home-btn:hover { background: #1565c0; }

        .main-card { max-width: 800px; margin: 60px auto 30px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 24px; }
        h1, h2, h3 { text-align: center; color: #333; margin-top: 0; }

        /* é–‹é–‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section-box { border: 1px solid #eee; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .section-header { background: #f5f5f5; padding: 12px 20px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .section-header:hover { background: #eeeeee; }
        .section-header::after { content: 'â–¼'; font-size: 0.8em; color: #999; transition: transform 0.2s; }
        .section-header.closed::after { transform: rotate(-90deg); }
        .section-body { padding: 20px; border-top: 1px solid #eee; display: block; animation: fadeIn 0.3s; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.95em; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f0f7ff; color: #333; }
        input.table-input { width: 90%; text-align: center; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }

        /* ã‚¬ãƒãƒ£ã‚¨ãƒªã‚¢ */
        .gacha-play-area { text-align: center; background: #fafafa; padding: 20px; border-radius: 8px; border: 1px solid #eee; }
        .btn-draw { background: linear-gradient(135deg, #42a5f5, #1976d2); color: white; padding: 12px 30px; font-size: 1.2em; font-weight: bold; border-radius: 30px; border: none; cursor: pointer; box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3); margin: 5px; transition: transform 0.1s; }
        .btn-draw:active { transform: scale(0.98); }
        
        #result-area { margin-top: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; background: #fff; }
        .result-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .result-item:last-child { border-bottom: none; }

        .rarity-badge { display: inline-block; width: 50px; text-align: center; padding: 2px 0; margin-right: 10px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.85em; }
        .bg-0 { background: #9e9e9e; } .bg-1 { background: #4caf50; } .bg-2 { background: #03a9f4; } .bg-3 { background: #ff9800; } .bg-4 { background: #e91e63; }
        
        .btn-add-row { background: #1976d2; color: white; width: 100%; padding: 10px; border: 2px dashed #bbdefb; border-radius: 4px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-add-row:hover { background: #e3f2fd; color: #1976d2; border-style: solid; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 600px) { .home-btn { padding: 8px 16px; font-size: 0.9em; } .main-card { margin-top: 70px; padding: 15px; } }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>

    <div class="main-card">
        <h1>ã‚¬ãƒãƒ£è¨­å®šãƒ»æŠ½é¸</h1>

        <div class="section-box">
            <div class="section-header closed" onclick="toggleSection('sec-basic', this)">åŸºæœ¬è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
            <div id="sec-basic" class="section-body" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <div><label>ã‚¬ãƒãƒ£å: <input type="text" id="gacha-title" value="ãƒã‚¤ã‚¬ãƒãƒ£" oninput="saveData()"></label></div>
                    <button class="btn-red" onclick="resetAll()">å±¥æ­´å…¨å‰Šé™¤</button>
                </div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-header closed" onclick="toggleSection('sec-rarity', this)">ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¨­å®š</div>
            <div id="sec-rarity" class="section-body" style="display:none;">
                <div style="margin-bottom:10px;">
                    <label>ãƒ¬ã‚¢ãƒªãƒ†ã‚£æ•°: <input type="number" id="rarity-count" value="5" min="1" max="5" style="width:60px;" onchange="updateRarityTable()"></label>
                    <span style="font-size:0.8em; color:#888; margin-left:10px;">â€»å¤‰æ›´ã™ã‚‹ã¨ç¢ºç‡ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</span>
                </div>
                <table>
                    <thead><tr><th>åç§°</th><th>å‡ºç¾ç‡ (%)</th><th>è‰²</th></tr></thead>
                    <tbody id="rarity-tbody"></tbody>
                </table>
                <div style="text-align:right; font-size:0.9em;">åˆè¨ˆ: <span id="total-prob" style="font-weight:bold;">0</span>%</div>
            </div>
        </div>

        <div class="section-box">
            <div class="section-header closed" onclick="toggleSection('sec-prize', this)">æ™¯å“è¨­å®š</div>
            <div id="sec-prize" class="section-body" style="display:none;">
                <div style="margin-bottom:10px;">ç¾åœ¨ã®æ™¯å“æ•°: <span id="prize-count-display" style="font-weight:bold;">0</span> å€‹</div>
                <table>
                    <thead><tr><th style="width:40px;">No</th><th style="width:110px;">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</th><th style="width:80px;">ç¢ºç‡</th><th>æ™¯å“å</th><th style="width:50px;">æ“ä½œ</th></tr></thead>
                    <tbody id="prize-tbody"></tbody>
                </table>
                <button class="btn-add-row" onclick="addPrize()">ï¼‹ æ™¯å“ã‚’è¿½åŠ </button>
            </div>
        </div>

        <div class="gacha-play-area">
            <h2 style="margin-bottom:20px;">ã‚¬ãƒãƒ£æŠ½é¸</h2>
            <div style="margin-bottom:20px;">
                <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥åŠ› (çœç•¥å¯)" style="width:200px; text-align:center; padding:8px;">
            </div>
            <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;">
                <button class="btn-draw" onclick="drawGacha(1)">1å›</button>
                <button class="btn-draw" onclick="drawGacha(10)">10é€£</button>
            </div>
            <div style="margin-top:20px; display:flex; justify-content:center; align-items:center; gap:10px;">
                 <span style="font-size:0.9em; color:#555;">å›æ•°æŒ‡å®š:</span>
                 <input type="number" id="custom-draw-count" value="100" style="width:70px; padding:6px; text-align:center;">
                 <button class="btn-blue" style="padding:6px 15px;" onclick="drawCustom()">å›ã™</button>
            </div>
        </div>

        <div id="result-area">
            <div style="text-align:center; color:#ccc; padding:20px;">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
        </div>

        <div id="copy-area" style="text-align:center; margin-top:20px; display:none;">
            <button class="btn-green" onclick="copyResult()">ğŸ“‹ çµæœã‚’ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>

<script>
    // --- å¤‰æ•°ãƒ»åˆæœŸåŒ– ---
    let lastResults = [];
    let lastDrawCount = 0;

    let config = {
        title: "ãƒã‚¤ã‚¬ãƒãƒ£",
        rarities: [
            // æ¨™æº–çš„ãªç¢ºç‡è¨­å®š (N=50, R=30...)
            { name: "N", rate: 50 },
            { name: "R", rate: 30 },
            { name: "SR", rate: 15 },
            { name: "SSR", rate: 4 },
            { name: "UR", rate: 1 }
        ],
        prizes: []
    };

    window.onload = function() { loadData(); };

    // --- ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹é–‰ ---
    function toggleSection(id, headerEl) {
        const el = document.getElementById(id);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            headerEl.classList.remove('closed');
        } else {
            el.style.display = 'none';
            headerEl.classList.add('closed');
        }
    }

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ ---
    function loadData() {
        const stored = localStorage.getItem('iriam_highspec_gacha');
        if (stored) {
            config = JSON.parse(stored);
            document.getElementById('gacha-title').value = config.title;
            document.getElementById('rarity-count').value = config.rarities.length;
            if(config.prizes.length === 0) initPrizes(10);
        } else {
            initPrizes(10); 
        }
        renderRarityTable();
        renderPrizeTable();
    }

    function saveData() {
        config.title = document.getElementById('gacha-title').value;
        localStorage.setItem('iriam_highspec_gacha', JSON.stringify(config));
    }

    function initPrizes(count) {
        config.prizes = [];
        for(let i=0; i<count; i++) {
            config.prizes.push({ name: "æ™¯å“ " + (i+1), rarityIndex: 0 });
        }
        saveData();
    }

    // --- ãƒ¬ã‚¢ãƒªãƒ†ã‚£å‡¦ç† ---
    function updateRarityTable() {
        const count = parseInt(document.getElementById('rarity-count').value);
        if (count < 1) return;
        const currentLen = config.rarities.length;
        if (count > currentLen) {
            for (let i = currentLen; i < count; i++) {
                config.rarities.push({ name: "Rank"+(i+1), rate: 0 });
            }
        } else if (count < currentLen) {
            config.rarities.splice(count);
        }
        saveData();
        renderRarityTable();
        renderPrizeTable();
    }

    function renderRarityTable() {
        const tbody = document.getElementById('rarity-tbody');
        tbody.innerHTML = '';
        let total = 0;
        config.rarities.forEach((r, index) => {
            total += parseFloat(r.rate) || 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="table-input" value="${r.name}" oninput="updateRarityData(${index}, 'name', this.value)"></td>
                <td><input type="number" class="table-input" value="${r.rate}" oninput="updateRarityData(${index}, 'rate', this.value)"></td>
                <td><span class="rarity-badge bg-${index % 5}">Color</span></td>
            `;
            tbody.appendChild(tr);
        });
        const totalEl = document.getElementById('total-prob');
        totalEl.textContent = total.toFixed(2);
        totalEl.style.color = Math.abs(total - 100) < 0.01 ? '#2e7d32' : '#d32f2f';
    }

    function updateRarityData(index, field, value) {
        if (field === 'rate') value = parseFloat(value);
        config.rarities[index][field] = value;
        saveData();
        if(field === 'rate') renderRarityTable();
        if(field === 'name') renderPrizeTable();
    }

    // --- æ™¯å“å‡¦ç† ---
    function addPrize() {
        config.prizes.push({ name: "æ–°è¦æ™¯å“", rarityIndex: 0 });
        saveData();
        renderPrizeTable();
    }

    function deletePrize(index) {
        if(config.prizes.length <= 1) {
            alert("æ™¯å“ã¯æœ€ä½1ã¤å¿…è¦ã§ã™");
            return;
        }
        config.prizes.splice(index, 1);
        saveData();
        renderPrizeTable();
    }

    function renderPrizeTable() {
        const tbody = document.getElementById('prize-tbody');
        tbody.innerHTML = '';
        document.getElementById('prize-count-display').textContent = config.prizes.length;

        const rarityCounts = new Array(config.rarities.length).fill(0);
        config.prizes.forEach(p => {
            if(p.rarityIndex < config.rarities.length) rarityCounts[p.rarityIndex]++;
        });

        config.prizes.forEach((p, index) => {
            let options = '';
            config.rarities.forEach((r, rIdx) => {
                options += `<option value="${rIdx}" ${p.rarityIndex == rIdx ? 'selected' : ''}>${r.name}</option>`;
            });
            let individualRate = "0.00";
            if (p.rarityIndex < config.rarities.length && rarityCounts[p.rarityIndex] > 0) {
                individualRate = (config.rarities[p.rarityIndex].rate / rarityCounts[p.rarityIndex]).toFixed(2);
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><select onchange="updatePrizeData(${index}, 'rarityIndex', this.value)">${options}</select></td>
                <td style="color:#666; font-size:0.9em;">${individualRate}%</td>
                <td><input type="text" class="table-input" value="${p.name}" oninput="updatePrizeData(${index}, 'name', this.value)" style="text-align:left;"></td>
                <td><button class="btn-red" onclick="deletePrize(${index})">å‰Šé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updatePrizeData(index, field, value) {
        if (field === 'rarityIndex') value = parseInt(value);
        config.prizes[index][field] = value;
        saveData();
        if (field === 'rarityIndex') renderPrizeTable(); 
    }

    // --- ã‚¬ãƒãƒ£ãƒ­ã‚¸ãƒƒã‚¯ ---
    function drawCustom() {
        const count = parseInt(document.getElementById('custom-draw-count').value);
        drawGacha(count);
    }

    function drawGacha(times) {
        let totalRate = config.rarities.reduce((sum, r) => sum + (parseFloat(r.rate)||0), 0);
        if (Math.abs(totalRate - 100) > 0.1) {
            alert("åˆè¨ˆç¢ºç‡ãŒ100%ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚(ç¾åœ¨: " + totalRate.toFixed(2) + "%)");
            return;
        }
        if (config.prizes.length === 0) {
            alert("æ™¯å“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        const prizesByRarity = [];
        config.rarities.forEach(() => prizesByRarity.push([]));
        config.prizes.forEach(p => {
            if(prizesByRarity[p.rarityIndex]) prizesByRarity[p.rarityIndex].push(p);
        });

        const results = [];
        for(let i=0; i<times; i++) {
            const rand = Math.random() * 100;
            let current = 0;
            let rIdx = -1;
            for(let r=0; r<config.rarities.length; r++) {
                current += config.rarities[r].rate;
                if (rand < current) { rIdx = r; break; }
            }
            if(rIdx === -1) rIdx = config.rarities.length - 1;

            const list = prizesByRarity[rIdx];
            if (list && list.length > 0) {
                const prize = list[Math.floor(Math.random() * list.length)];
                results.push({ rName: config.rarities[rIdx].name, rIdx: rIdx, name: prize.name });
            } else {
                results.push({ rName: config.rarities[rIdx].name, rIdx: rIdx, name: "(ç©º)" });
            }
        }

        lastResults = results;
        lastDrawCount = times;

        // çµæœè¡¨ç¤º (å˜ç´”ãƒªã‚¹ãƒˆ)
        let html = "";
        const userName = document.getElementById('user-name').value || "åç„¡ã—";
        const date = new Date().toLocaleString();
        
        html += `<div style="padding:10px; border-bottom:1px solid #ddd; margin-bottom:10px; background:#f9f9f9; text-align:center;">
            <strong>${userName}</strong> ã•ã‚“ã®çµæœ (${times}å›) <br><span style="font-size:0.8em; color:#888;">${date}</span>
        </div>`;

        results.forEach((r, idx) => {
            html += `<div class="result-item">
                <span style="color:#aaa; font-size:0.8em; margin-right:10px; width:25px;">${idx+1}</span>
                <span class="rarity-badge bg-${r.rIdx % 5}">${r.rName}</span>
                <span style="font-weight:bold;">${r.name}</span>
            </div>`;
        });
        document.getElementById('result-area').innerHTML = html;
        document.getElementById('copy-area').style.display = 'block';
    }

    // --- ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ (ã¾ã¨ã‚ã¦ãƒ»é«˜ãƒ¬ã‚¢é †) ---
    function copyResult() {
        if (lastResults.length === 0) return;
        const userName = document.getElementById('user-name').value || "åç„¡ã—";
        const title = config.title;

        // é›†è¨ˆ (Map: åå‰ -> {count, rName, rIdx})
        const summary = new Map();
        lastResults.forEach(r => {
            if (summary.has(r.name)) {
                summary.get(r.name).count++;
            } else {
                summary.set(r.name, { ...r, count: 1 });
            }
        });

        // é…åˆ—ã«ã—ã¦ã€ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †(rIdxé™é †)ã§ã‚½ãƒ¼ãƒˆ
        const sortedItems = Array.from(summary.values()).sort((a, b) => b.rIdx - a.rIdx);

        // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        let text = `ã€${title}ã€‘${userName}ã•ã‚“ã®çµæœ (${lastDrawCount}å›)\n`;
        sortedItems.forEach(item => {
            const countStr = item.count > 1 ? ` x${item.count}` : "";
            text += `[${item.rName}] ${item.name}${countStr}\n`;
        });
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                alert("çµæœã‚’ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\n(é«˜ãƒ¬ã‚¢é †)");
            }).catch(err => {
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
            });
        } else {
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
        }
    }

    function resetAll() {
        if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('iriam_highspec_gacha');
            location.reload();
        }
    }
</script>
</body>
</html>
