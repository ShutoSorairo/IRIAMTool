<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é«˜æ©Ÿèƒ½ã‚¬ãƒãƒ£è¨­å®š</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <style>
        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card {
            background: #fff;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã— (ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰) */
        .section-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        .section-title:hover { color: #1976d2; }
        .section-title::after { content: 'â–¼'; font-size: 0.8em; color: #ccc; transition: transform 0.2s; }
        .section-title.closed::after { transform: rotate(-90deg); }
        .section-content { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.95em; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; }
        th { background-color: #f9f9f9; color: #555; font-weight: bold; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        input[type="text"], input[type="number"], select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input.table-input { width: 95%; text-align: center; border: 1px solid #eee; }
        input.table-input:focus { border-color: #1976d2; background: #fdfdfd; }

        /* ãƒœã‚¿ãƒ³ */
        button {
            padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer;
            font-size: 0.95em; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        .btn-primary { background: #1976d2; color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-success { background: #2e7d32; color: white; } /* ã‚³ãƒ”ãƒ¼ç”¨ */
        
        .btn-draw { 
            padding: 12px 30px; font-size: 1.1em; font-weight: bold; border-radius: 30px;
            background: linear-gradient(135deg, #42a5f5, #1976d2); color: white;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3);
        }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-area {
            margin-top: 15px; max-height: 400px; overflow-y: auto;
            border: 1px solid #eee; border-radius: 4px; background: #fafafa; padding: 10px;
        }
        .result-item {
            display: flex; align-items: center; padding: 8px;
            border-bottom: 1px solid #eee; background: #fff;
        }
        .result-item:last-child { border-bottom: none; }
        
        /* ãƒ¬ã‚¢ãƒªãƒ†ã‚£è‰² */
        .rarity-tag {
            display: inline-block; width: 50px; text-align: center; font-weight: bold;
            font-size: 0.85em; margin-right: 10px; padding: 2px 5px;
            border-radius: 3px; color: #fff;
        }
        .bg-0 { background: #9e9e9e; }
        .bg-1 { background: #4caf50; }
        .bg-2 { background: #03a9f4; }
        .bg-3 { background: #ff9800; }
        .bg-4 { background: #e91e63; }
    </style>
</head>
<body>

    <div style="text-align:center; margin-top:20px;">
        <a href="index.html" style="color:#666; text-decoration:none;">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
    </div>

    <div class="card">
        <div class="section-title closed" onclick="toggleSection('sec-basic', this)">åŸºæœ¬è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
        <div id="sec-basic" class="section-content" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div>
                    <label>ã‚¬ãƒãƒ£å: <input type="text" id="gacha-title" value="ãƒã‚¤ã‚¬ãƒãƒ£" oninput="saveData()"></label>
                </div>
                <button class="btn-danger" onclick="resetAll()">å±¥æ­´å…¨å‰Šé™¤</button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title closed" onclick="toggleSection('sec-rarity', this)">ãƒ¬ã‚¢ãƒªãƒ†ã‚£è¨­å®š</div>
        <div id="sec-rarity" class="section-content" style="display:none;">
            <div style="margin-bottom:10px;">
                <label>ãƒ¬ã‚¢ãƒªãƒ†ã‚£æ•°: <input type="number" id="rarity-count" value="5" min="1" max="5" style="width:60px;" onchange="updateRarityTable()"></label>
                <span style="font-size:0.8em; color:#888; margin-left:10px;">â€»å¤‰æ›´ã™ã‚‹ã¨ç¢ºç‡ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</span>
            </div>
            <table>
                <thead>
                    <tr><th>åç§°</th><th>å‡ºç¾ç‡ (%)</th><th>è‰²</th></tr>
                </thead>
                <tbody id="rarity-tbody"></tbody>
            </table>
            <div style="text-align:right; font-size:0.9em; color:#666;">
                åˆè¨ˆ: <span id="total-prob" style="font-weight:bold;">0</span>%
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title closed" onclick="toggleSection('sec-prize', this)">æ™¯å“è¨­å®š</div>
        <div id="sec-prize" class="section-content" style="display:none;">
            <div style="margin-bottom:10px;">
                <label>æ™¯å“æ•°: <input type="number" id="prize-count" value="10" min="1" style="width:60px;" onchange="updatePrizeTable()"></label>
            </div>
            <table>
                <thead>
                    <tr><th style="width:40px;">No</th><th style="width:100px;">ãƒ¬ã‚¢ãƒªãƒ†ã‚£</th><th style="width:80px;">ç¢ºç‡</th><th>æ™¯å“å</th></tr>
                </thead>
                <tbody id="prize-tbody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h2 style="text-align:center; color:#333; margin-top:0;">ã‚¬ãƒãƒ£æŠ½é¸</h2>
        <div style="text-align:center; margin-bottom:20px;">
            <input type="text" id="user-name" placeholder="åå‰ã‚’å…¥åŠ›" style="width:200px; text-align:center;">
        </div>

        <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;">
            <button class="btn-draw" onclick="drawGacha(1)">1å›</button>
            <button class="btn-draw" onclick="drawGacha(10)">10é€£</button>
        </div>
        
        <div style="text-align:center; margin-top:15px;">
             <small style="color:#666;">å›æ•°æŒ‡å®š: </small>
             <input type="number" id="custom-draw-count" value="100" style="width:60px; padding:5px;">
             <button class="btn-primary" style="padding:5px 10px; font-size:0.9em;" onclick="drawCustom()">å›ã™</button>
        </div>

        <h3 style="margin-top:30px; margin-bottom:10px; font-size:1em; color:#555;">æŠ½é¸çµæœ</h3>
        
        <div id="result-area">
            <div style="text-align:center; color:#ccc; padding:20px;">
                ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã“ã“ã«çµæœãŒå‡ºã¾ã™
            </div>
        </div>

        <div id="copy-area" style="text-align:center; margin-top:15px; display:none;">
            <button class="btn-success" onclick="copyResult()">ğŸ“‹ çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆã§ã‚³ãƒ”ãƒ¼</button>
        </div>
    </div>

<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: æœ€æ–°ã®çµæœã‚’ä¿æŒã™ã‚‹
    let lastResults = [];
    let lastDrawCount = 0;

    function toggleSection(id, titleEl) {
        const el = document.getElementById(id);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            titleEl.classList.remove('closed');
        } else {
            el.style.display = 'none';
            titleEl.classList.add('closed');
        }
    }

    let config = {
        title: "ãƒã‚¤ã‚¬ãƒãƒ£",
        rarities: [
            { name: "N", rate: 50 },
            { name: "R", rate: 30 },
            { name: "SR", rate: 15 },
            { name: "SSR", rate: 4 },
            { name: "UR", rate: 1 }
        ],
        prizes: []
    };

    window.onload = function() { loadData(); };

    function loadData() {
        const stored = localStorage.getItem('iriam_highspec_gacha');
        if (stored) {
            config = JSON.parse(stored);
            document.getElementById('gacha-title').value = config.title;
            document.getElementById('rarity-count').value = config.rarities.length;
            if(config.prizes.length === 0) initPrizes(10);
            document.getElementById('prize-count').value = config.prizes.length;
        } else { initPrizes(10); }
        renderRarityTable();
        renderPrizeTable();
    }

    function saveData() {
        config.title = document.getElementById('gacha-title').value;
        localStorage.setItem('iriam_highspec_gacha', JSON.stringify(config));
    }

    function initPrizes(count) {
        config.prizes = [];
        for(let i=0; i<count; i++) {
            config.prizes.push({ name: "æ™¯å“ " + (i+1), rarityIndex: 0 });
        }
        saveData();
    }

    function updateRarityTable() {
        const count = parseInt(document.getElementById('rarity-count').value);
        if (count < 1) return;
        const currentLen = config.rarities.length;
        if (count > currentLen) {
            for (let i = currentLen; i < count; i++) {
                config.rarities.push({ name: "Rank"+(i+1), rate: 0 });
            }
        } else if (count < currentLen) {
            config.rarities.splice(count);
        }
        saveData();
        renderRarityTable();
        renderPrizeTable();
    }

    function renderRarityTable() {
        const tbody = document.getElementById('rarity-tbody');
        tbody.innerHTML = '';
        let total = 0;
        config.rarities.forEach((r, index) => {
            total += parseFloat(r.rate) || 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="table-input" value="${r.name}" oninput="updateRarityData(${index}, 'name', this.value)"></td>
                <td><input type="number" class="table-input" value="${r.rate}" oninput="updateRarityData(${index}, 'rate', this.value)"></td>
                <td><span class="rarity-tag bg-${index % 5}">Color</span></td>
            `;
            tbody.appendChild(tr);
        });
        const totalEl = document.getElementById('total-prob');
        totalEl.textContent = total.toFixed(2);
        totalEl.style.color = Math.abs(total - 100) < 0.01 ? '#2e7d32' : '#d32f2f';
    }

    function updateRarityData(index, field, value) {
        if (field === 'rate') value = parseFloat(value);
        config.rarities[index][field] = value;
        saveData();
        if(field === 'rate') renderRarityTable();
        if(field === 'name') renderPrizeTable();
    }

    function updatePrizeTable() {
        const count = parseInt(document.getElementById('prize-count').value);
        if (count < 1) return;
        const currentLen = config.prizes.length;
        if (count > currentLen) {
            for (let i = currentLen; i < count; i++) {
                config.prizes.push({ name: "æ–°è¦æ™¯å“", rarityIndex: 0 });
            }
        } else if (count < currentLen) {
            if(confirm("æœ«å°¾ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                config.prizes.splice(count);
            } else {
                document.getElementById('prize-count').value = currentLen; 
                return;
            }
        }
        saveData();
        renderPrizeTable();
    }

    function renderPrizeTable() {
        const tbody = document.getElementById('prize-tbody');
        tbody.innerHTML = '';
        const rarityCounts = new Array(config.rarities.length).fill(0);
        config.prizes.forEach(p => {
            if(p.rarityIndex < config.rarities.length) rarityCounts[p.rarityIndex]++;
        });

        config.prizes.forEach((p, index) => {
            let options = '';
            config.rarities.forEach((r, rIdx) => {
                options += `<option value="${rIdx}" ${p.rarityIndex == rIdx ? 'selected' : ''}>${r.name}</option>`;
            });
            let individualRate = "0.00";
            if (p.rarityIndex < config.rarities.length && rarityCounts[p.rarityIndex] > 0) {
                individualRate = (config.rarities[p.rarityIndex].rate / rarityCounts[p.rarityIndex]).toFixed(2);
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td><select onchange="updatePrizeData(${index}, 'rarityIndex', this.value)">${options}</select></td>
                <td style="color:#666; font-size:0.9em;">${individualRate}%</td>
                <td><input type="text" class="table-input" value="${p.name}" oninput="updatePrizeData(${index}, 'name', this.value)" style="text-align:left;"></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updatePrizeData(index, field, value) {
        if (field === 'rarityIndex') value = parseInt(value);
        config.prizes[index][field] = value;
        saveData();
        if (field === 'rarityIndex') renderPrizeTable(); 
    }

    function drawCustom() {
        const count = parseInt(document.getElementById('custom-draw-count').value);
        drawGacha(count);
    }

    function drawGacha(times) {
        let totalRate = config.rarities.reduce((sum, r) => sum + (parseFloat(r.rate)||0), 0);
        if (Math.abs(totalRate - 100) > 0.1) {
            alert("åˆè¨ˆç¢ºç‡ãŒ100%ã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚(ç¾åœ¨: " + totalRate.toFixed(2) + "%)");
            return;
        }
        if (config.prizes.length === 0) {
            alert("æ™¯å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }

        const prizesByRarity = [];
        config.rarities.forEach(() => prizesByRarity.push([]));
        config.prizes.forEach(p => {
            if(prizesByRarity[p.rarityIndex]) prizesByRarity[p.rarityIndex].push(p);
        });

        const results = [];
        for(let i=0; i<times; i++) {
            const rand = Math.random() * 100;
            let current = 0;
            let rIdx = -1;
            for(let r=0; r<config.rarities.length; r++) {
                current += config.rarities[r].rate;
                if (rand < current) { rIdx = r; break; }
            }
            if(rIdx === -1) rIdx = config.rarities.length - 1;

            const list = prizesByRarity[rIdx];
            if (list && list.length > 0) {
                const prize = list[Math.floor(Math.random() * list.length)];
                results.push({ rName: config.rarities[rIdx].name, rIdx: rIdx, name: prize.name });
            } else {
                results.push({ rName: config.rarities[rIdx].name, rIdx: rIdx, name: "(ç©º)" });
            }
        }

        // çµæœã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        lastResults = results;
        lastDrawCount = times;

        // è¡¨ç¤º
        let html = "";
        const userName = document.getElementById('user-name').value || "åç„¡ã—";
        const date = new Date().toLocaleString();
        
        html += `<div style="padding:10px; border-bottom:1px solid #ddd; margin-bottom:10px; background:#f0f0f0;">
            <strong>${userName}</strong> ã•ã‚“ã®çµæœ (${times}å›) <span style="font-size:0.8em; color:#888;">${date}</span>
        </div>`;

        results.forEach((r, idx) => {
            html += `<div class="result-item">
                <span style="color:#aaa; font-size:0.8em; margin-right:10px; width:20px;">${idx+1}</span>
                <span class="rarity-tag bg-${r.rIdx % 5}">${r.rName}</span>
                <span style="font-weight:bold;">${r.name}</span>
            </div>`;
        });
        document.getElementById('result-area').innerHTML = html;
        
        // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('copy-area').style.display = 'block';
    }

    // â˜…è¿½åŠ : ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    function copyResult() {
        if (lastResults.length === 0) return;

        const userName = document.getElementById('user-name').value || "åç„¡ã—";
        const title = config.title;
        let text = `ã€${title}ã€‘${userName}ã•ã‚“ã®æŠ½é¸çµæœ (${lastDrawCount}å›)\n`;
        
        lastResults.forEach((r) => {
            text += `[${r.rName}] ${r.name}\n`;
        });
        
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nX(Twitter)ãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");
            }).catch(err => {
                console.error("ã‚³ãƒ”ãƒ¼å¤±æ•—", err);
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
        } else {
            // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãªã©
            alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚");
        }
    }

    function resetAll() {
        if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('iriam_highspec_gacha');
            location.reload();
        }
    }
</script>
</body>
</html>
